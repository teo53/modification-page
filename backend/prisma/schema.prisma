// =============================================================================
// ğŸ“ prisma/schema.prisma
// ğŸ·ï¸  QueenAlba í”„ë¡œë•ì…˜ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ
// ğŸ“… Created: 2024-12-18
// âœ¨ Features: ë©€í‹°í…Œë„ŒíŠ¸, ê´‘ê³ , ì»¤ë®¤ë‹ˆí‹°, ê²°ì œ, íˆìŠ¤í† ë¦¬
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ğŸ¢ TENANT (ë©€í‹°ì‚¬ì´íŠ¸ ì§€ì›)
// =============================================================================

model Tenant {
  id          String   @id @default(uuid())
  name        String   // ë‚´ë¶€ ì‹ë³„ì (ì˜ˆ: queenalba, lunaalba)
  displayName String   @map("display_name") // í‘œì‹œëª…
  domain      String?  @unique // ì»¤ìŠ¤í…€ ë„ë©”ì¸
  subdomain   String?  @unique // ì„œë¸Œë„ë©”ì¸
  
  // ë¸Œëœë”©
  logoUrl        String?  @map("logo_url")
  faviconUrl     String?  @map("favicon_url")
  primaryColor   String   @default("#D4AF37") @map("primary_color")
  secondaryColor String   @default("#1A1A2E") @map("secondary_color")
  
  // ì„¤ì • (JSON)
  settings    Json     @default("{}")  // ì‚¬ì´íŠ¸ë³„ ì»¤ìŠ¤í…€ ì„¤ì •
  features    Json     @default("{}")  // í™œì„±í™”ëœ ê¸°ëŠ¥ í”Œë˜ê·¸
  
  // ìƒíƒœ
  isActive    Boolean  @default(true) @map("is_active")
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  users           User[]
  ads             Ad[]
  adProducts      AdProduct[]
  payments        Payment[]
  communityPosts  CommunityPost[]
  reports         Report[]
  
  @@map("tenants")
}

// =============================================================================
// ğŸ‘¤ USER (íšŒì›)
// =============================================================================

model User {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  
  // ì¸ì¦
  email         String
  passwordHash  String   @map("password_hash")
  
  // ì—­í• 
  role          UserRole @default(SEEKER)
  
  // í”„ë¡œí•„
  name          String?
  nickname      String?
  phone         String?
  phoneVerified Boolean  @default(false) @map("phone_verified")
  profileImage  String?  @map("profile_image")
  
  // ì£¼ì†Œ
  address       String?
  addressDetail String?  @map("address_detail")
  
  // ê¸°ì—…íšŒì› ì •ë³´
  businessName          String?  @map("business_name")
  businessNumber        String?  @map("business_number")
  businessVerified      Boolean  @default(false) @map("business_verified")
  businessCertificateUrl String? @map("business_certificate_url")
  
  // ë™ì˜ í•­ëª©
  agreePrivacy    Boolean  @default(false) @map("agree_privacy")
  agreeTerms      Boolean  @default(false) @map("agree_terms")
  agreeMarketing  Boolean  @default(false) @map("agree_marketing")
  
  // ìƒíƒœ
  isActive    Boolean  @default(true) @map("is_active")
  isBanned    Boolean  @default(false) @map("is_banned")
  banReason   String?  @map("ban_reason")
  lastLoginAt DateTime? @map("last_login_at")
  lastLoginIp String?  @map("last_login_ip")
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  
  // Relations
  ads             Ad[]
  payments        Payment[]
  refreshTokens   RefreshToken[]
  communityPosts  CommunityPost[]
  comments        CommunityComment[]
  bookmarks       Bookmark[]
  notifications   Notification[]
  reports         Report[]          @relation("reporter")
  
  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@index([role])
  @@index([phone])
  @@map("users")
}

enum UserRole {
  SEEKER      // ì¼ë°˜ êµ¬ì§ì
  EMPLOYER    // ê´‘ê³ ì£¼
  MODERATOR   // ìš´ì˜ì
  ADMIN       // ê´€ë¦¬ì
  SUPER_ADMIN // ìŠˆí¼ ê´€ë¦¬ì (ë§ˆìŠ¤í„° CRM)
}

// =============================================================================
// ğŸ“¢ AD (ê´‘ê³ )
// =============================================================================

model Ad {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  productId String?  @map("product_id")
  product   AdProduct? @relation(fields: [productId], references: [id])
  
  // ==============================
  // ì—…ì†Œ ì •ë³´ (Step 1)
  // ==============================
  businessName    String   @map("business_name")
  managerName     String?  @map("manager_name")
  managerPhone    String?  @map("manager_phone")
  
  // ë©”ì‹ ì €
  contactKakao    String?  @map("contact_kakao")
  contactLine     String?  @map("contact_line")
  contactTelegram String?  @map("contact_telegram")
  contactWechat   String?  @map("contact_wechat")
  
  // ì£¼ì†Œ
  zonecode        String?
  roadAddress     String?  @map("road_address")
  addressDetail   String?  @map("address_detail")
  isLocationVerified Boolean @default(false) @map("is_location_verified")
  
  // ë¡œê³ 
  businessLogoUrl String?  @map("business_logo_url")
  adLogoUrl       String?  @map("ad_logo_url")
  
  // ==============================
  // ëª¨ì§‘ ì •ë³´ (Step 2)
  // ==============================
  title           String
  description     String?  @db.Text
  
  // ì—…ì§ì¢…
  industryLevel1  String?  @map("industry_level1")
  industryLevel2  String?  @map("industry_level2")
  
  // ìœ„ì¹˜
  region          String?
  district        String?
  town            String?
  
  // ì±„ìš© ì¡°ê±´
  recruitmentType String?  @map("recruitment_type")
  recruitNumber   String?  @map("recruit_number")
  
  // ê·¼ë¬´ ì¡°ê±´
  workHoursType   String?  @map("work_hours_type")
  workHoursStart  String?  @map("work_hours_start")
  workHoursEnd    String?  @map("work_hours_end")
  workDays        String[] @default([]) @map("work_days")
  
  // ê¸‰ì—¬
  salaryType      String?  @map("salary_type")
  salaryAmount    String?  @map("salary_amount")
  
  // ì§€ì›ì ì¡°ê±´
  ageMin          Int?     @map("age_min")
  ageMax          Int?     @map("age_max")
  ageNoLimit      Boolean  @default(false) @map("age_no_limit")
  gender          String?
  experience      String?
  daysOff         String?  @map("days_off")
  
  // ë§ˆê°
  deadlineDate    DateTime? @map("deadline_date")
  deadlineAlways  Boolean   @default(false) @map("deadline_always")
  
  // ì¶”ê°€ ì •ë³´ (ë°°ì—´)
  welfare             String[] @default([])
  preferredConditions String[] @default([]) @map("preferred_conditions")
  receptionMethods    String[] @default([]) @map("reception_methods")
  requiredDocuments   String[] @default([]) @map("required_documents")
  keywords            String[] @default([])
  themes              String[] @default([])
  
  // ==============================
  // ì´ë¯¸ì§€
  // ==============================
  thumbnail       String?
  images          String[] @default([])
  
  // ==============================
  // ê´‘ê³  ì˜µì…˜ (Step 3)
  // ==============================
  highlightConfig Json?    @map("highlight_config")  // {color, text, range}
  jumpUpConfig    Json?    @map("jump_up_config")    // {enabled, interval, count, remaining}
  
  // ==============================
  // ìƒíƒœ ë° í†µê³„
  // ==============================
  badges          String[] @default([])
  isUrgent        Boolean  @default(false) @map("is_urgent")
  isHot           Boolean  @default(false) @map("is_hot")
  isNew           Boolean  @default(true) @map("is_new")
  
  status          AdStatus @default(PENDING)
  rejectReason    String?  @map("reject_reason")
  
  startDate       DateTime @default(now()) @map("start_date")
  endDate         DateTime? @map("end_date")
  
  viewCount       Int      @default(0) @map("view_count")
  clickCount      Int      @default(0) @map("click_count")
  applyCount      Int      @default(0) @map("apply_count")
  
  // ì •ë ¬ ìš°ì„ ìˆœìœ„ (ë†’ì„ìˆ˜ë¡ ìƒë‹¨)
  sortPriority    Int      @default(0) @map("sort_priority")
  lastJumpUpAt    DateTime? @map("last_jump_up_at")
  
  // ==============================
  // ê´‘ê³  ì´ë ¥ ì¶”ì  (queenalba ìŠ¤íƒ€ì¼)
  // ==============================
  // ê´‘ê³ ì£¼ì˜ ê´‘ê³  íšŒì°¨ (ëª‡ ë²ˆì§¸ ê´‘ê³ ì¸ì§€)
  rotationCount   Int      @default(1) @map("rotation_count")
  // í•´ë‹¹ ê´‘ê³ ì£¼ì˜ ì²« ê´‘ê³  ë“±ë¡ì¼ (activeDays ê³„ì‚°ìš©)
  firstAdDate     DateTime @default(now()) @map("first_ad_date")
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")
  
  // Relations
  payments        Payment[]
  views           AdView[]
  histories       AdHistory[]
  bookmarks       Bookmark[]
  
  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([region])
  @@index([industryLevel2])
  @@index([createdAt])
  @@index([sortPriority, createdAt])
  @@map("ads")
}

enum AdStatus {
  DRAFT     // ì„ì‹œì €ì¥
  PENDING   // ìŠ¹ì¸ ëŒ€ê¸°
  ACTIVE    // í™œì„±
  PAUSED    // ì¼ì‹œ ì¤‘ì§€
  EXPIRED   // ë§Œë£Œ
  REJECTED  // ê±°ì ˆ
}

// =============================================================================
// ğŸ“¦ AD PRODUCT (ê´‘ê³  ìƒí’ˆ)
// =============================================================================

model AdProduct {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  
  name          String
  code          String   // 'diamond', 'sapphire', 'ruby', 'gold', 'premium', 'special', 'highlight', 'general'
  price         Int
  durationDays  Int      @map("duration_days")
  
  // ê¸°ëŠ¥
  description   String?
  features      Json     @default("[]")
  maxSlots      Int?     @map("max_slots")      // ìµœëŒ€ ìŠ¬ë¡¯ ìˆ˜ (ì˜ˆ: ë‹¤ì´ì•„ 2ê°œ)
  sortPriority  Int      @default(0) @map("sort_priority")
  
  isActive      Boolean  @default(true) @map("is_active")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  ads           Ad[]
  
  @@unique([tenantId, code])
  @@map("ad_products")
}

// =============================================================================
// ğŸ“Š AD HISTORY (ê´‘ê³  ë³€ê²½ ì´ë ¥)
// =============================================================================

model AdHistory {
  id          String   @id @default(uuid())
  adId        String   @map("ad_id")
  ad          Ad       @relation(fields: [adId], references: [id])
  
  action      AdHistoryAction
  changes     Json?    // {field: {old: x, new: y}}
  
  performedBy String?  @map("performed_by")  // userId
  performerRole String? @map("performer_role")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@index([adId])
  @@index([createdAt])
  @@map("ad_histories")
}

enum AdHistoryAction {
  CREATED
  UPDATED
  STATUS_CHANGED
  EXTENDED
  EXPIRED
  PAUSED
  RESUMED
  DELETED
  RESTORED
  JUMP_UP
}

// =============================================================================
// ğŸ‘ï¸ AD VIEW (ì¡°íšŒ ê¸°ë¡)
// =============================================================================

model AdView {
  id        String   @id @default(uuid())
  adId      String   @map("ad_id")
  ad        Ad       @relation(fields: [adId], references: [id])
  
  userId    String?  @map("user_id")  // ë¡œê·¸ì¸ ì‚¬ìš©ì
  sessionId String?  @map("session_id")  // ë¹„ë¡œê·¸ì¸ ì„¸ì…˜
  ipHash    String   @map("ip_hash")
  userAgent String?  @map("user_agent")
  referer   String?
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([adId])
  @@index([createdAt])
  @@map("ad_views")
}

// =============================================================================
// ğŸ’³ PAYMENT (ê²°ì œ)
// =============================================================================

model Payment {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  adId      String?  @map("ad_id")
  ad        Ad?      @relation(fields: [adId], references: [id])
  
  // ê²°ì œ ì •ë³´
  orderNo       String   @unique @map("order_no")
  amount        Int
  currency      String   @default("KRW")
  productType   String   @map("product_type")
  productName   String?  @map("product_name")
  
  // PG ì •ë³´
  pgProvider      String?  @map("pg_provider")  // toss, nice, kg, etc.
  pgTransactionId String?  @map("pg_transaction_id")
  pgResponse      Json?    @map("pg_response")
  receiptUrl      String?  @map("receipt_url")
  
  // ìƒíƒœ
  status        PaymentStatus @default(PENDING)
  failReason    String?  @map("fail_reason")
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt     DateTime @default(now()) @map("created_at")
  paidAt        DateTime? @map("paid_at")
  cancelledAt   DateTime? @map("cancelled_at")
  refundedAt    DateTime? @map("refunded_at")
  
  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([orderNo])
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
  PARTIAL_REFUND
}

// =============================================================================
// ğŸ”‘ REFRESH TOKEN (ì¸ì¦ í† í°)
// =============================================================================

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token     String   @unique
  family    String   // í† í° ì¬ì‚¬ìš© íƒì§€ìš©
  
  deviceInfo  String?  @map("device_info")
  ipAddress   String?  @map("ip_address")
  
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([token])
  @@index([family])
  @@map("refresh_tokens")
}

// =============================================================================
// ğŸ“ COMMUNITY POST (ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œê¸€)
// =============================================================================

model CommunityPost {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  userId      String?  @map("user_id")
  user        User?    @relation(fields: [userId], references: [id])
  
  category    PostCategory
  title       String
  content     String   @db.Text  // HTML
  
  // ìµëª… ì§€ì›
  authorName    String?  @map("author_name")
  authorIpHash  String?  @map("author_ip_hash")
  password      String?  // ìµëª… ìˆ˜ì •/ì‚­ì œìš© (í•´ì‹±ë¨)
  
  // í†µê³„
  viewCount     Int      @default(0) @map("view_count")
  likeCount     Int      @default(0) @map("like_count")
  commentCount  Int      @default(0) @map("comment_count")
  
  // ìƒíƒœ
  isPinned      Boolean  @default(false) @map("is_pinned")
  isNotice      Boolean  @default(false) @map("is_notice")
  isHidden      Boolean  @default(false) @map("is_hidden")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")
  
  // Relations
  comments      CommunityComment[]
  
  @@index([tenantId, category])
  @@index([createdAt])
  @@index([isPinned, createdAt])
  @@map("community_posts")
}

enum PostCategory {
  FREE     // ììœ ê²Œì‹œíŒ
  QNA      // ì§ˆë¬¸ë‹µë³€
  REVIEW   // í›„ê¸°
  TIP      // ë…¸í•˜ìš°/íŒ
  NEWS     // ì—…ê³„ì†Œì‹
}

// =============================================================================
// ğŸ’¬ COMMUNITY COMMENT (ëŒ“ê¸€)
// =============================================================================

model CommunityComment {
  id        String   @id @default(uuid())
  postId    String   @map("post_id")
  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String?  @map("user_id")
  user      User?    @relation(fields: [userId], references: [id])
  parentId  String?  @map("parent_id")  // ëŒ€ëŒ“ê¸€
  
  content   String
  
  // ìµëª…
  authorName    String?  @map("author_name")
  authorIpHash  String?  @map("author_ip_hash")
  password      String?
  
  likeCount     Int      @default(0) @map("like_count")
  isHidden      Boolean  @default(false) @map("is_hidden")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")
  
  @@index([postId])
  @@index([parentId])
  @@map("community_comments")
}

// =============================================================================
// ğŸ”– BOOKMARK (ì¦ê²¨ì°¾ê¸°)
// =============================================================================

model Bookmark {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  targetType BookmarkType @map("target_type")
  targetId   String   @map("target_id")
  
  // ê´‘ê³  ì¦ê²¨ì°¾ê¸° ì‹œ ì§ì ‘ ì—°ê²°
  adId      String?  @map("ad_id")
  ad        Ad?      @relation(fields: [adId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime @default(now()) @map("created_at")
  
  @@unique([userId, targetType, targetId])
  @@index([userId])
  @@map("bookmarks")
}

enum BookmarkType {
  AD
  POST
}

// =============================================================================
// ğŸ”” NOTIFICATION (ì•Œë¦¼)
// =============================================================================

model Notification {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      NotificationType
  title     String
  message   String
  link      String?
  data      Json?    // ì¶”ê°€ ë°ì´í„°
  
  isRead    Boolean  @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  AD_APPROVED
  AD_REJECTED
  AD_EXPIRING
  AD_EXPIRED
  PAYMENT_COMPLETED
  PAYMENT_FAILED
  COMMENT_RECEIVED
  REPLY_RECEIVED
  REPORT_RESOLVED
  SYSTEM
}

// =============================================================================
// ğŸš¨ REPORT (ì‹ ê³ )
// =============================================================================

model Report {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  reporterId  String?  @map("reporter_id")
  reporter    User?    @relation("reporter", fields: [reporterId], references: [id])
  
  targetType  ReportTargetType  @map("target_type")
  targetId    String   @map("target_id")
  
  reason      ReportReason
  description String?  @db.Text
  
  status      ReportStatus @default(PENDING)
  
  resolvedBy  String?  @map("resolved_by")
  resolvedAt  DateTime? @map("resolved_at")
  resolution  String?
  
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@index([tenantId, status])
  @@index([targetType, targetId])
  @@map("reports")
}

enum ReportTargetType {
  AD
  POST
  COMMENT
  USER
}

enum ReportReason {
  SPAM
  INAPPROPRIATE
  FRAUD
  COPYRIGHT
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWING
  RESOLVED
  DISMISSED
}

// =============================================================================
// ğŸŒ NETWORK AD PLACEMENT (ê´‘ê³  ë„¤íŠ¸ì›Œí¬ - í–¥í›„ í™•ì¥)
// =============================================================================

model NetworkAdPlacement {
  id              String   @id @default(uuid())
  adId            String   @map("ad_id")
  sourceTenantId  String   @map("source_tenant_id")
  targetTenantId  String   @map("target_tenant_id")
  
  impressions     Int      @default(0)
  clicks          Int      @default(0)
  
  startDate       DateTime @map("start_date")
  endDate         DateTime @map("end_date")
  
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@index([sourceTenantId])
  @@index([targetTenantId])
  @@map("network_ad_placements")
}

// =============================================================================
// ğŸ’° SETTLEMENT (ì •ì‚° - í–¥í›„ í™•ì¥)
// =============================================================================

model Settlement {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  
  periodStart   DateTime @map("period_start")
  periodEnd     DateTime @map("period_end")
  
  grossRevenue  Int      @map("gross_revenue")
  platformFee   Int      @map("platform_fee")
  pgFee         Int      @map("pg_fee")
  netPayout     Int      @map("net_payout")
  
  status        SettlementStatus @default(PENDING)
  
  bankInfo      Json?    @map("bank_info")  // ì •ì‚° ê³„ì¢Œ ì •ë³´
  
  paidAt        DateTime? @map("paid_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  
  @@index([tenantId])
  @@index([status])
  @@map("settlements")
}

enum SettlementStatus {
  PENDING
  APPROVED
  PAID
  DISPUTED
}
