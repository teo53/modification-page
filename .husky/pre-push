#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo ""
echo "ðŸš€ Pre-push ê²€ì‚¬ ì‹œìž‘..."
echo "=================================================="

# Skip in CI environment
if [ -n "$CI" ]; then
  echo "â„¹ï¸  CI í™˜ê²½ ê°ì§€ - pre-push í›… ìŠ¤í‚µ"
  exit 0
fi

# Function to handle errors
handle_error() {
  echo ""
  echo "âŒ Pre-push ê²€ì‚¬ ì‹¤íŒ¨: $1"
  echo "=================================================="
  echo "ðŸ’¡ í‘¸ì‹œê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ìœ„ì˜ ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
  exit 1
}

# 1. Check if package.json has been modified
echo ""
echo "1ï¸âƒ£  ì˜ì¡´ì„± ë³€ê²½ í™•ì¸..."
if git diff --cached --name-only | grep -q "package.json"; then
  echo "   âš ï¸  package.jsonì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."
  echo "   ðŸ“Œ ì˜ì¡´ì„± ë³€ê²½ ì‹œ íŠ¹ížˆ ì£¼ì˜: Prisma, NestJS, React ë“± í•µì‹¬ íŒ¨í‚¤ì§€"
fi

# 2. Quick type check for critical files
echo ""
echo "2ï¸âƒ£  TypeScript ë¹ ë¥¸ ê²€ì‚¬..."
if command -v npx &> /dev/null; then
  # Check API types
  if [ -d "apps/api" ]; then
    cd apps/api
    npx tsc --noEmit --skipLibCheck 2>/dev/null || handle_error "Backend TypeScript ì˜¤ë¥˜"
    cd ../..
  fi
fi
echo "   âœ… TypeScript ê²€ì‚¬ í†µê³¼"

# 3. Quick build test (optional - can be commented out for faster pushes)
echo ""
echo "3ï¸âƒ£  ë¹Œë“œ í…ŒìŠ¤íŠ¸ (types íŒ¨í‚¤ì§€)..."
if [ -d "packages/types" ]; then
  pnpm --filter @lunaalba/types build 2>/dev/null || handle_error "Types ë¹Œë“œ ì‹¤íŒ¨"
fi
echo "   âœ… Types ë¹Œë“œ í†µê³¼"

# 4. Prisma generate test
echo ""
echo "4ï¸âƒ£  Prisma í´ë¼ì´ì–¸íŠ¸ ìƒì„± í…ŒìŠ¤íŠ¸..."
if [ -d "apps/api/prisma" ]; then
  cd apps/api
  npx prisma generate 2>/dev/null || handle_error "Prisma generate ì‹¤íŒ¨"
  cd ../..
fi
echo "   âœ… Prisma ê²€ì‚¬ í†µê³¼"

echo ""
echo "=================================================="
echo "âœ… ëª¨ë“  Pre-push ê²€ì‚¬ í†µê³¼!"
echo "=================================================="
echo ""
